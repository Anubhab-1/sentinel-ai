{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between mb-8">
        <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-white sm:text-3xl sm:truncate">
                Security Dashboard
            </h2>
            <p class="mt-1 text-gray-400">
                Overview of your security posture and recent scan activity.
            </p>
        </div>
        <div class="mt-4 flex md:mt-0 md:ml-4">
            <button onclick="fetchStats()"
                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Refresh Data
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-3 mb-8">
        <!-- Total Scans -->
        <div class="bg-gray-800 overflow-hidden shadow rounded-lg border border-gray-700">
            <div class="px-4 py-5 sm:p-6">
                <dt class="text-sm font-medium text-gray-400 truncate">Total Scans Run</dt>
                <dd class="mt-1 text-3xl font-semibold text-white" id="total-scans">-</dd>
            </div>
        </div>
        <!-- Avg Risk -->
        <div class="bg-gray-800 overflow-hidden shadow rounded-lg border border-gray-700">
            <div class="px-4 py-5 sm:p-6">
                <dt class="text-sm font-medium text-gray-400 truncate">Average Risk Score</dt>
                <dd class="mt-1 text-3xl font-semibold text-white" id="avg-score">-</dd>
            </div>
        </div>
        <!-- Security Grade -->
        <div class="bg-gray-800 overflow-hidden shadow rounded-lg border border-gray-700">
            <div class="px-4 py-5 sm:p-6">
                <dt class="text-sm font-medium text-gray-400 truncate">Overall Security Grade</dt>
                <dd class="mt-1 text-3xl font-semibold text-green-400" id="grade">-</dd>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 gap-8 lg:grid-cols-2 mb-8">
        <!-- Distribution Chart -->
        <div class="bg-gray-800 shadow rounded-lg p-6 border border-gray-700">
            <h3 class="text-lg leading-6 font-medium text-white mb-4">Vulnerability Distribution</h3>
            <div class="relative h-64">
                <canvas id="distChart"></canvas>
            </div>
        </div>

        <!-- Risk Trend (Simulated for now, or just another view) -->
        <div class="bg-gray-800 shadow rounded-lg p-6 border border-gray-700">
            <h3 class="text-lg leading-6 font-medium text-white mb-4">Risk Severity Breakdown</h3>
            <div class="relative h-64">
                <canvas id="severityBarChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Scans Table -->
    <div class="bg-gray-800 shadow overflow-hidden sm:rounded-lg border border-gray-700">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-700">
            <h3 class="text-lg leading-6 font-medium text-white">Recent Activity</h3>
            <p class="mt-1 max-w-2xl text-sm text-gray-400">Latest scans performed.</p>
        </div>
        <div class="border-t border-gray-700 overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-900">
                    <tr>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                            Target</th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Risk
                            Score</th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                            Findings (H/M/L)</th>
                    </tr>
                </thead>
                <tbody id="recent-table-body" class="bg-gray-800 divide-y divide-gray-700">
                    <!-- JS inserts rows here -->
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let distChartInstance = null;
    let barChartInstance = null;

    async function fetchStats() {
        try {
            const response = await fetch('/api/stats');
            const data = await response.json();

            // Update Cards
            document.getElementById('total-scans').innerText = data.total_scans;
            document.getElementById('avg-score').innerText = data.average_risk_score;

            // Calculate Grade
            const score = data.average_risk_score;
            let grade = 'A';
            let color = 'text-green-400';
            if (score > 20) { grade = 'B'; color = 'text-yellow-400'; }
            if (score > 50) { grade = 'C'; color = 'text-orange-400'; }
            if (score > 75) { grade = 'F'; color = 'text-red-500'; }

            const gradeEl = document.getElementById('grade');
            gradeEl.innerText = grade;
            gradeEl.className = `mt-1 text-3xl font-semibold ${color}`;

            // Update Charts
            updateCharts(data);

            // Update Table
            updateTable(data.recent_scans);

        } catch (error) {
            console.error('Error loading dashboard:', error);
        }
    }

    function updateCharts(data) {
        const ctxDist = document.getElementById('distChart').getContext('2d');
        const ctxBar = document.getElementById('severityBarChart').getContext('2d');

        // Destroy old if exists
        if (distChartInstance) distChartInstance.destroy();
        if (barChartInstance) barChartInstance.destroy(); // Fix: destroy correct instance

        const counts = data.severity_distribution;

        // 1. Doughnut Chart (High/Med/Low)
        distChartInstance = new Chart(ctxDist, {
            type: 'doughnut',
            data: {
                labels: ['High', 'Medium', 'Low'],
                datasets: [{
                    data: [counts.High, counts.Medium, counts.Low],
                    backgroundColor: [
                        '#EF4444', // Red-500
                        '#F59E0B', // Amber-500
                        '#10B981'  // Emerald-500
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#ffffff' } }
                }
            }
        });

        // 2. Bar Chart (Same data, different view for now, usually would be timeline)
        barChartInstance = new Chart(ctxBar, { // Use unique instance
            type: 'bar',
            data: {
                labels: ['Severe', 'Moderate', 'Low Risk'],
                datasets: [{
                    label: 'Count',
                    data: [counts.High, counts.Medium, counts.Low],
                    backgroundColor: '#6366F1', // Indigo
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { color: '#374151' }, ticks: { color: '#9CA3AF' } },
                    x: { grid: { display: false }, ticks: { color: '#9CA3AF' } }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    function updateTable(scans) {
        const tbody = document.getElementById('recent-table-body');
        tbody.innerHTML = '';

        if (scans.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No scans yet.</td></tr>';
            return;
        }

        scans.forEach(scan => {
            const row = `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${scan.url}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${new Date(scan.created_at).toLocaleDateString()}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${scan.risk_score}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                    <span class="text-red-400 font-bold">${scan.high || 0}</span> / 
                    <span class="text-yellow-400 font-bold">${scan.medium || 0}</span> / 
                    <span class="text-green-400 font-bold">${scan.low || 0}</span>
                </td>
            </tr>
        `;
            tbody.insertAdjacentHTML('beforeend', row);
        });
    }

    // Load on start
    document.addEventListener('DOMContentLoaded', fetchStats);
</script>
{% endblock %}