{% extends "base.html" %}

{% block content %}
<div class="bg-grid-pattern"></div>
<div class="bg-glow-orb"
    style="top: 10%; right: 10%; background: radial-gradient(circle, rgba(255, 0, 85, 0.1) 0%, transparent 60%);"></div>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 relative z-10">

    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between mb-12">
        <div class="flex-1 min-w-0">
            <h2 class="text-3xl font-bold leading-7 text-white sm:text-4xl font-heading tracking-tight">
                Command Center
            </h2>
            <p class="mt-2 text-primary font-mono text-sm tracking-wider uppercase">
                // Security_Posture_Overview
            </p>
        </div>
        <div class="mt-4 flex md:mt-0 md:ml-4">
            <button onclick="fetchStats()" class="btn-cyber px-6 py-2 rounded flex items-center gap-2 group">
                <svg class="w-4 h-4 group-hover:rotate-180 transition-transform duration-500" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                    </path>
                </svg>
                Sync Data
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 gap-6 sm:grid-cols-3 mb-12">
        <!-- Total Scans -->
        <div class="glass-card flex items-center justify-between">
            <div>
                <dt class="text-sm font-medium text-gray-400 truncate uppercase tracking-widest">Total Operations</dt>
                <dd class="mt-2 text-4xl font-bold text-white font-mono" id="total-scans">-</dd>
            </div>
            <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                    </path>
                </svg>
            </div>
        </div>

        <!-- Avg Risk -->
        <div class="glass-card flex items-center justify-between">
            <div>
                <dt class="text-sm font-medium text-gray-400 truncate uppercase tracking-widest">Avg Risk Index</dt>
                <dd class="mt-2 text-4xl font-bold text-white font-mono" id="avg-score">-</dd>
            </div>
            <div class="w-12 h-12 rounded-full bg-red-500/10 flex items-center justify-center text-red-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
            </div>
        </div>

        <!-- Security Grade -->
        <div class="glass-card flex items-center justify-between">
            <div>
                <dt class="text-sm font-medium text-gray-400 truncate uppercase tracking-widest">System Grade</dt>
                <dd class="mt-2 text-4xl font-bold text-green-400 font-mono" id="grade">-</dd>
            </div>
            <div class="w-12 h-12 rounded-full bg-green-500/10 flex items-center justify-center text-green-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 gap-8 lg:grid-cols-2 mb-12">
        <!-- Distribution Chart -->
        <div class="glass-card">
            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-6 border-b border-gray-700 pb-2">
                Vulnerability Spectrum</h3>
            <div class="relative h-64">
                <canvas id="distChart"></canvas>
            </div>
        </div>

        <!-- Risk Trend -->
        <div class="glass-card">
            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-6 border-b border-gray-700 pb-2">
                Severity Breakdown</h3>
            <div class="relative h-64">
                <canvas id="severityBarChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Scans Table -->
    <div class="glass-card p-0 overflow-hidden">
        <div class="px-6 py-5 border-b border-gray-700/50 bg-gray-900/50">
            <h3 class="text-lg leading-6 font-bold text-white">Live Feed</h3>
            <p class="mt-1 max-w-2xl text-sm text-gray-400">Time-series data of recent scanning operations.</p>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700/50">
                <thead class="bg-gray-900/50">
                    <tr>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider font-mono">
                            Target System</th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider font-mono">
                            Timestamp</th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider font-mono">
                            Risk Score</th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-bold text-gray-300 uppercase tracking-wider font-mono">
                            Vectors (H/M/L)</th>
                    </tr>
                </thead>
                <tbody id="recent-table-body" class="divide-y divide-gray-700/50">
                    <!-- JS inserts rows here -->
                </tbody>
            </table>
        </div>
    </div>

</div>



<script>
    let distChartInstance = null;
    let barChartInstance = null;

    async function fetchStats() {
        try {
            const response = await fetch('/api/stats');
            const data = await response.json();

            // Update Cards
            document.getElementById('total-scans').innerText = data.total_scans;
            document.getElementById('avg-score').innerText = data.average_risk_score;

            // Calculate Grade
            const score = data.average_risk_score;
            let grade = 'A';
            let color = 'text-emerald-400';
            if (score > 20) { grade = 'B'; color = 'text-yellow-400'; }
            if (score > 50) { grade = 'C'; color = 'text-orange-400'; }
            if (score > 75) { grade = 'F'; color = 'text-red-500'; }

            const gradeEl = document.getElementById('grade');
            gradeEl.innerText = grade;
            gradeEl.className = `mt-2 text-4xl font-bold font-mono ${color}`;

            // Update Charts
            updateCharts(data);

            // Update Table
            updateTable(data.recent_scans);

        } catch (error) {
            console.error('Error loading dashboard:', error);
        }
    }

    function updateCharts(data) {
        const ctxDist = document.getElementById('distChart').getContext('2d');
        const ctxBar = document.getElementById('severityBarChart').getContext('2d');

        // Destroy old if exists
        if (distChartInstance) distChartInstance.destroy();
        if (barChartInstance) barChartInstance.destroy();

        const counts = data.severity_distribution;

        // 1. Doughnut Chart (High/Med/Low)
        distChartInstance = new Chart(ctxDist, {
            type: 'doughnut',
            data: {
                labels: ['High', 'Medium', 'Low'],
                datasets: [{
                    data: [counts.High, counts.Medium, counts.Low],
                    backgroundColor: [
                        '#ff0055', // Neon Red
                        '#f59e0b', // Amber-500
                        '#00f0ff'  // Cyber Cyan
                    ],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#e2e8f0', font: { family: "'Outfit', sans-serif" } } }
                }
            }
        });

        // 2. Bar Chart 
        barChartInstance = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: ['Severe', 'Moderate', 'Low Risk'],
                datasets: [{
                    label: 'Count',
                    data: [counts.High, counts.Medium, counts.Low],
                    backgroundColor: '#7000ff', // Neon Purple
                    borderRadius: 4,
                    barThickness: 30
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    function updateTable(scans) {
        const tbody = document.getElementById('recent-table-body');
        tbody.innerHTML = '';

        if (scans.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">No operations recorded.</td></tr>';
            return;
        }

        scans.forEach(scan => {
            const row = `
            <tr class="hover:bg-white/5 transition-colors">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-white font-mono border-l-2 border-transparent hover:border-primary">${scan.url}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 font-mono">${new Date(scan.created_at).toLocaleDateString()}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-white font-mono">${scan.risk_score}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 font-mono">
                    <span class="text-red-400 font-bold">${scan.high || 0}</span> / 
                    <span class="text-yellow-400 font-bold">${scan.medium || 0}</span> / 
                    <span class="text-cyan-400 font-bold">${scan.low || 0}</span>
                </td>
            </tr>
        `;
            tbody.insertAdjacentHTML('beforeend', row);
        });
    }

    // Load on start
    document.addEventListener('DOMContentLoaded', fetchStats);
</script>
{% endblock %}